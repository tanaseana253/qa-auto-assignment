<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CRUD App</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body class="container-fluid" style="padding:48px">
  <h2 class="pb-3">IT Projects Manager</h2>

  <form id="project-form" class="row g-3 align-items-end mb-4">
    <div class="col-md-2">
      <label for="name" class="form-label small">Project</label>
      <input type="text" id="name" class="form-control" placeholder="Project name" required>
    </div>
    <div class="col-md-2">
      <label for="start_date" class="form-label small">Start Date</label>
      <input type="date" id="start_date" class="form-control">
    </div>
    <div class="col-md-2">
      <label for="target_end_date" class="form-label small">Target End Date</label>
      <input type="date" id="target_end_date" class="form-control">
    </div>
    <div class="col-md-2">
      <label for="created_by" class="form-label small">Created by</label>
      <input type="text" id="created_by" class="form-control" placeholder="Username" required>
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary w-100" type="submit">Add Project</button>
    </div>
  </form>

  <table class="table table-bordered">
    <thead class="table-light" style="font-size: 12px">
      <tr>
        <th>PROJECT_ID</th>
        <th>PROJECT_NAME</th>
        <th>START_DATE</th>
        <th>TARGET_END_DATE</th>
        <th>ACTUAL_END_DATE</th>
        <th>CREATED_ON</th>
        <th>CREATED_BY</th>
        <th>MODIFIED_ON</th>
        <th>MODIFIED_BY</th>
        <th>ACTIONS</th>
      </tr>
    </thead>
    <tbody id="projects-table-body"></tbody>
  </table>

  <script>
    const api = '/projects';

// reload the full table with updated content
    function loadProjects() {
      fetch(api)
        .then(res => res.json())
        .then(data => {
          const tableBody = document.getElementById('projects-table-body');
          tableBody.innerHTML = '';

          data.forEach(project => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td class="text-left align-middle">${project.PROJECT_ID}</td>
              <td><input class="form-control" value="${project.PROJECT_NAME || ''}" data-field="PROJECT_NAME"></td>
              <td><input type="date" class="form-control" value="${(project.START_DATE || '').slice(0, 10)}" data-field="START_DATE" required></td>
              <td><input type="date" class="form-control" value="${(project.TARGET_END_DATE || '').slice(0, 10)}" data-field="TARGET_END_DATE" required></td>
              <td><input type="date" class="form-control" value="${(project.ACTUAL_END_DATE || '').slice(0, 10)}" data-field="ACTUAL_END_DATE" required></td>
              <td><input type="date" class="form-control" value="${(project.CREATED_ON || '').slice(0, 10)}" disabled></td>
              <td><input class="form-control" value="${project.CREATED_BY || ''}" data-field="CREATED_BY" disabled></td>
              <td><input type="date" class="form-control" value="${(project.MODIFIED_ON || '').slice(0, 10)}" disabled></td>
              <td><input class="form-control" value="${project.MODIFIED_BY || ''}" data-field="MODIFIED_BY"></td>
              <td class="text-center">
                <div class="d-flex justify-content-center gap-1">
                  <button class="btn btn-sm btn-warning" onclick="updateProject(${project.PROJECT_ID}, this)">
                    <i class="bi bi-check2"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteProject(${project.PROJECT_ID})">
                    <i class="bi bi-trash3"></i>
                  </button>
                </div>
              </td>
            `;
            tableBody.appendChild(row);

            // ðŸ”½ Apply min date constraints immediately
            const startInput = row.querySelector('input[data-field="START_DATE"]');
            const targetInput = row.querySelector('input[data-field="TARGET_END_DATE"]');
            const actualInput = row.querySelector('input[data-field="ACTUAL_END_DATE"]');

            if (startInput && targetInput) targetInput.min = startInput.value;
            if (startInput && actualInput) actualInput.min = startInput.value;

            // Optional: update min values when start date changes
            startInput?.addEventListener('change', () => {
              if (targetInput) targetInput.min = startInput.value;
              if (actualInput) actualInput.min = startInput.value;
            });
          });
        });
    }

    //Fonction to update a project
    // This function is called when the update button is clicked
    window.updateProject = function (id, button) {
      const row = button.closest('tr');
      const inputs = row.querySelectorAll('input[data-field]');
      const updatedData = {};

      inputs.forEach(input => {
        updatedData[input.dataset.field] = input.value;
      });

      const start = updatedData.START_DATE;
      const target = updatedData.TARGET_END_DATE;
      const actual = updatedData.ACTUAL_END_DATE;

      // Simple JS validation with alert-style message
      if (start && target && target < start) {
        alert('Target End Date cannot be earlier than Start Date.');
        return;
      }
      if (start && actual && actual < start) {
        alert('Actual End Date cannot be earlier than Start Date.');
        return;
      }

      fetch(`${api}/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedData)
      })
        .then(res => {
          if (!res.ok) throw new Error('Failed to update project');
          loadProjects();
        })
        .catch(err => console.error(err));
    };


    // Function to delete a project
    // This function is called when the delete button is clicked
    window.deleteProject = function (id) {
      if (!confirm('Are you sure you want to delete this project?')) return;

      fetch(`${api}/${id}`, { 
        method: 'DELETE' })
        .then(res => {
          if (!res.ok) throw new Error('Failed to delete project');
          return res.json();
        })
        .then(() => {
          loadProjects();
        })
        .catch(err => console.error('Delete error:', err));
    };

    document.addEventListener('DOMContentLoaded', function () {
      const startDateInput = document.getElementById('start_date');
      const targetEndDateInput = document.getElementById('target_end_date');

      startDateInput.addEventListener('change', () => {
        targetEndDateInput.min = startDateInput.value;

      });


      document.getElementById('project-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const start = startDateInput.value;
        const target = targetEndDateInput.value;

        const project = {
          PROJECT_NAME: document.getElementById('name').value,
          START_DATE: start,
          TARGET_END_DATE: target,
          CREATED_BY: document.getElementById('created_by').value
        };

        fetch(api, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(project)
        })
        .then(res => {
          if (!res.ok) throw new Error('Failed to add project');
          document.getElementById('project-form').reset();
          loadProjects();
        })
        .catch(err => console.error(err));
      });

      loadProjects();
    });
  </script>
</body>
</html>
